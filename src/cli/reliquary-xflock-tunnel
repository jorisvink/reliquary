#!/bin/sh

set -e

if [ -z "$RELIQUARY" ]; then
	RELIQUARY=$HOME/.config/reliquary
fi

DIR=$RELIQUARY

if [ $# -ne 4 ] ; then
	echo -n "Usage: reliquary-xflock-tunnel flock_src flock_dst "
	echo "peer-kek-id ip/mask"

	echo ""
	echo "The xflock variation of reliquary-tunnel-config"
	echo ""
	echo "Configures a tunnel between your device and the device specified"
	echo "by the peer-kek-id. It will route the provided network over the"
	echo "tunnel."

	echo ""
	echo "After doing this, a tunnel can be brought up using hymn:"
	echo "    $ sudo hymn up <flock_src>-<flock_dst>-<src>-<dst>"

	exit 1
fi

if [ ! -f $DIR/$1/device_kek ]; then
	echo "The device registration is not yet completed for $1 (no kek)"
	exit 1
fi

natport=`cat $DIR/natport`
src=`cat $DIR/$1/device_kek`
cathedral=`cat $DIR/cathedral`
cathedral_id=`cat $DIR/$1/cathedral_id`

user=`whoami`
host=`uname -s`

if [ "$host" = "OpenBSD" ]; then
	SUDO=doas
else
	SUDO=sudo
fi

$SUDO hymn add $1:$2-$src-$3 tunnel $4 cathedral $cathedral \
    kek $DIR/$1/kek-0x$src identity $cathedral_id:$DIR/$1/id-$cathedral_id \
    cosk $DIR/$1/cosk-$cathedral_id natport $natport user $user

$SUDO hymn remembrance $1:$2-$src-$3 on

echo "Tunnel $1:$2-$src-$3 has been configured."
echo "Please use hymn from now on to bring it up, down or to delete it."
echo ""
echo "    $ sudo hymn up $1:$2-$src-$3"
echo "    $ sudo hymn down $1:$2-$src-$3"
echo "    $ sudo hymn status $1:$2-$src-$3"
echo "    $ sudo hymn del $1:$2-$src-$3"
